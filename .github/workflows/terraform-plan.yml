name: Terraform Plan Only

on:
  workflow_dispatch:  # Manual trigger
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'prod'
        type: choice
        options:
          - prod
      destroy:
        description: 'Run terraform plan -destroy'
        required: false
        default: false
        type: boolean
  
  pull_request:
    branches: [ main ]
    paths:
      - 'terraform/**'
      - '.github/workflows/terraform-plan.yml'

env:
  AWS_REGION: us-east-1
  TF_VERSION: 1.9.8

permissions:
  contents: read
  pull-requests: write  # For PR comments

jobs:
  terraform-plan:
    name: Terraform Plan (Production)
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: terraform
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Terraform
      uses: hashicorp/setup-terraform@v3
      with:
        terraform_version: ${{ env.TF_VERSION }}
        
    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}
        
    - name: Terraform Format Check
      id: fmt
      run: terraform fmt -check -diff -recursive
      continue-on-error: true
      
    - name: Terraform Init
      id: init
      run: terraform init
      
    - name: Terraform Validate
      id: validate
      run: terraform validate
      
    - name: Verify terraform.tfvars
      run: |
        if [ -f "terraform.tfvars" ]; then
          echo "âœ… Found existing terraform.tfvars file"
          echo "ğŸ“„ Current terraform.tfvars content:"
          cat terraform.tfvars
          
          # Verify required variables are present
          if grep -q "vpc_id" terraform.tfvars && grep -q "private_subnet_ids" terraform.tfvars; then
            echo "âœ… VPC configuration found in terraform.tfvars"
          else
            echo "âš ï¸  VPC configuration missing in terraform.tfvars"
            echo "Please ensure vpc_id and private_subnet_ids are configured"
          fi
        else
          echo "âŒ No terraform.tfvars file found!"
          echo "Please create terraform.tfvars with your VPC configuration"
          exit 1
        fi
        
    - name: Terraform Plan
      id: plan
      run: |
        # Determine plan options
        PLAN_OPTIONS=""
        if [ "${{ github.event.inputs.destroy }}" = "true" ]; then
          PLAN_OPTIONS="-destroy"
          echo "ğŸ”¥ Running DESTROY plan"
        fi
        
        # Run terraform plan using existing terraform.tfvars
        echo "ğŸš€ Running terraform plan with existing terraform.tfvars configuration"
        terraform plan $PLAN_OPTIONS -no-color -out=tfplan
        
        # Generate human-readable output
        terraform show -no-color tfplan > plan_output.txt 2>/dev/null || echo "Plan output not available" > plan_output.txt
        
        # Create summary
        echo "## Plan Summary" > plan_summary.txt
        if [ "${{ github.event.inputs.destroy }}" = "true" ]; then
          echo "ğŸ”¥ **DESTROY PLAN** - This will delete resources!" >> plan_summary.txt
        fi
        echo "Environment: Production" >> plan_summary.txt
        echo "AWS Region: ${{ env.AWS_REGION }}" >> plan_summary.txt
        echo "Repository: ${{ github.repository }}" >> plan_summary.txt
        echo "" >> plan_summary.txt
        
        # Extract resource changes
        if terraform show -json tfplan > /dev/null 2>&1; then
          CHANGES=$(terraform show -json tfplan | jq -r '.resource_changes[]?.change.actions[]?' 2>/dev/null | sort | uniq -c | sort -nr || echo "Could not parse changes")
          echo "Resource Changes:" >> plan_summary.txt
          echo '```' >> plan_summary.txt
          echo "$CHANGES" >> plan_summary.txt
          echo '```' >> plan_summary.txt
        fi
      continue-on-error: true
      
    - name: Upload Plan Artifact
      uses: actions/upload-artifact@v4
      with:
        name: terraform-plan-prod-${{ github.run_number }}
        path: |
          terraform/tfplan
          terraform/plan_output.txt
          terraform/plan_summary.txt
          terraform/terraform.tfvars
        retention-days: 30
        
    - name: Comment on Pull Request
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request'
      with:
        github-token: ${{ secrets.GITHUB_TOKEN }}
        script: |
          const fs = require('fs');
          
          // Read plan outputs
          let planOutput = '';
          let summary = '';
          
          try {
            planOutput = fs.readFileSync('terraform/plan_output.txt', 'utf8');
            summary = fs.readFileSync('terraform/plan_summary.txt', 'utf8');
          } catch (error) {
            planOutput = 'Could not read plan output';
            summary = 'Could not read plan summary';
          }
          
          const output = `## ğŸ—ï¸ Terraform Plan Results
          
          ${summary}
          
          #### Terraform Format Check ğŸ–Œ \`${{ steps.fmt.outcome }}\`
          #### Terraform Initialization âš™ï¸ \`${{ steps.init.outcome }}\`
          #### Terraform Validation ğŸ¤– \`${{ steps.validate.outcome }}\`
          #### Terraform Plan ğŸ“‹ \`${{ steps.plan.outcome }}\`
          
          <details><summary>ğŸ“– Show Full Plan Output</summary>
          
          \`\`\`terraform
          ${planOutput.length > 60000 ? planOutput.substring(0, 60000) + '\n\n... (output truncated, check artifacts for full plan)' : planOutput}
          \`\`\`
          
          </details>
          
          ---
          *ğŸ¤– Auto-generated by [Terraform Plan workflow](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) | ğŸ‘¤ Triggered by @${{ github.actor }}*`;
          
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: output
          })
          
    - name: Job Summary
      if: always()
      run: |
        echo "## ğŸ—ï¸ Terraform Plan Summary" >> $GITHUB_STEP_SUMMARY
        
        if [ -f "plan_summary.txt" ]; then
          cat plan_summary.txt >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### Step Results:" >> $GITHUB_STEP_SUMMARY
        echo "- Format: ${{ steps.fmt.outcome }}" >> $GITHUB_STEP_SUMMARY
        echo "- Init: ${{ steps.init.outcome }}" >> $GITHUB_STEP_SUMMARY
        echo "- Validate: ${{ steps.validate.outcome }}" >> $GITHUB_STEP_SUMMARY
        echo "- Plan: ${{ steps.plan.outcome }}" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "âœ… **VPC Configuration**: Using terraform.tfvars file" >> $GITHUB_STEP_SUMMARY
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ğŸ“¦ **Artifacts**: Plan files uploaded for 30 days" >> $GITHUB_STEP_SUMMARY
        
    - name: Plan Status Check
      if: steps.plan.outcome == 'failure'
      run: |
        echo "âŒ Terraform plan failed - check the plan output above for details"
        exit 1